╔══════════════════════════════════════════════════════════════════════════════╗
║           HEMOSENSE - CCHF RISK PREDICTION SYSTEM DIAGRAM v2.1               ║
║                    Fully Model-Driven ML Architecture                         ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│                              USER INTERFACE                                   │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐ │
│  │   COLUMN 1     │  │   COLUMN 2     │  │         COLUMN 3               │ │
│  │   Symptoms     │  │   Exposure     │  │   Clinical & Context           │ │
│  ├────────────────┤  ├────────────────┤  ├────────────────────────────────┤ │
│  │ ☑ Fever        │  │ ☑ Tick Bite    │  │ Platelet Count: [200000]      │ │
│  │   Days: [0-30] │  │ ☑ Livestock    │  │ Month: [Dropdown]             │ │
│  │ ☑ Bleeding     │  │ ☑ Slaughter    │  │ Region: [Dropdown]            │ │
│  │   Days: [0-30] │  │ Occupation:    │  │ ☑ Low WBC                     │ │
│  │ ☑ Headache     │  │   [Dropdown]   │  │ ☑ Elevated AST/ALT            │ │
│  │ ☑ Vomiting     │  │                │  │ Mode: ◉ Public ○ Doctor       │ │
│  │ ☑ Muscle Pain  │  │                │  │                               │ │
│  └────────────────┘  └────────────────┘  └────────────────────────────────┘ │
│                                                                               │
│                      [🔵 Predict Risk Level Button]                          │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                    FEATURE ENGINEERING LAYER (28 Features)                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  FEATURE CONVERSIONS (No Heuristic Adjustments)                       │  │
│  │                                                                        │  │
│  │  • platelet_count → platelet_low (binary: < 150,000)                  │  │
│  │  • month → month_sin = sin(2π × month / 12)  [cyclical encoding]      │  │
│  │  • month → month_cos = cos(2π × month / 12)  [cyclical encoding]      │  │
│  │  • occupation → occupation_risk score (0.05–0.40) [input feature]     │  │
│  │  • region → region_risk score (0.05–0.95) [input feature]             │  │
│  │  • region → endemic_level (0, 1, 2) [input feature]                   │  │
│  │  • fever/bleeding → binary indicators + duration tracking             │  │
│  │                                                                        │  │
│  │  NOTE: All risk factors are encoded as INPUT FEATURES for the model.  │  │
│  │        No probability multipliers are applied after prediction.        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                    MACHINE LEARNING MODELS (Model-Driven)                     │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │              GradientBoostingClassifier / RandomForestClassifier       │  │
│  │                       (model_v2.pkl, stage_model_v2.pkl)               │  │
│  │                                                                        │  │
│  │  TRAINING:                                                             │  │
│  │  • 5-fold stratified cross-validation                                  │  │
│  │  • 80/20 train/test split                                              │  │
│  │  • Model comparison: GradientBoosting vs RandomForest vs LogisticReg   │  │
│  │  • Best model selected by F1-score (macro)                             │  │
│  │                                                                        │  │
│  │  INPUT FEATURES (28 total):                                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │ SYMPTOMS (10): fever, bleeding, headache, muscle_pain, vomiting │  │  │
│  │  │                dizziness, neck_pain, photophobia, abdominal,    │  │  │
│  │  │                diarrhea                                         │  │  │
│  │  │                                                                 │  │  │
│  │  │ EXPOSURE (5):  tick_bite, livestock_contact, slaughter_exposure │  │  │
│  │  │                healthcare_exposure, human_contact               │  │  │
│  │  │                                                                 │  │  │
│  │  │ CLINICAL (5):  platelet_low, wbc_low, ast_alt_high,            │  │  │
│  │  │                liver_impairment, shock_signs                    │  │  │
│  │  │                                                                 │  │  │
│  │  │ CONTEXT (3):   occupation_risk, region_risk, endemic_level      │  │  │
│  │  │                                                                 │  │  │
│  │  │ TEMPORAL (3):  days_since_tick, days_since_contact, symptom_days│  │  │
│  │  │                                                                 │  │  │
│  │  │ SEASONAL (2):  month_sin, month_cos                             │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  OUTPUT: Direct Probabilities from model.predict_proba()              │  │
│  │  • Risk Model:  [P(Low), P(Medium), P(High)]                          │  │
│  │  • Stage Model: [P(Early), P(Hemorrhagic), P(Severe)]                 │  │
│  │                                                                        │  │
│  │  ⚠️  NO POST-PREDICTION ADJUSTMENTS ARE APPLIED                       │  │
│  │      All contextual risk factors are learned during training.         │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          OUTPUT & VISUALIZATION LAYER                         │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐ │  │
│  │  │   RISK GAUGE     │  │  PROBABILITY     │  │    CONFIDENCE        │ │  │
│  │  │   (Plotly)       │  │  CHART (Plotly)  │  │    INDICATOR         │ │  │
│  │  │                  │  │                  │  │                      │ │  │
│  │  │      ┌───┐       │  │  ▓▓▓ Low: 20%   │  │  Model Confidence:   │ │  │
│  │  │     ╱     ╲      │  │  ▓▓▓ Med: 30%   │  │       85.5%          │ │  │
│  │  │    │   ●   │     │  │  ▓▓▓ High: 50%  │  │                      │ │  │
│  │  │     ╲     ╱      │  │                  │  │  (Direct from model) │ │  │
│  │  │      └───┘       │  │                  │  │                      │ │  │
│  │  │   🟢 🟡 🔴      │  │  🟢 🟡 🔴      │  │                      │ │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────┘ │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │        STAGE PREDICTION (Model-Driven)                          │ │  │
│  │  │  Early │ Hemorrhagic │ Severe                                   │ │  │
│  │  │   ▓▓   │    ▓▓▓▓▓    │   ▓▓                                    │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │        AI EXPLANATION (Gemini-Powered)                          │ │  │
│  │  │  Based on WHO guidelines, explains why the model made its       │ │  │
│  │  │  prediction given the patient's clinical presentation.          │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │           CLINICAL RECOMMENDATIONS                               │ │  │
│  │  │  🏥 Immediate hospitalization and isolation                      │ │  │
│  │  │  🧪 PCR testing for CCHF virus confirmation                      │ │  │
│  │  │  💉 Supportive care and ribavirin therapy consideration          │ │  │
│  │  │  🩸 Monitor coagulation parameters and platelet count            │ │  │
│  │  │  ⚠️ Implement strict infection control measures                 │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                        │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐ │  │
│  │  │  [📄 Generate PDF Report]  [⬇️ Download PDF Report]             │ │  │
│  │  └──────────────────────────────────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                   MODEL TRANSPARENCY DASHBOARD                                │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  📊 METRICS TAB                                                        │  │
│  │  • 5-fold cross-validation results                                    │  │
│  │  • Holdout test set metrics                                           │  │
│  │  • Model comparison table (RF vs LR vs GB)                            │  │
│  │                                                                        │  │
│  │  📈 ROC CURVES TAB                                                     │  │
│  │  • Per-class ROC curves for Risk model                                │  │
│  │  • Per-class ROC curves for Stage model                               │  │
│  │  • AUC scores displayed                                               │  │
│  │                                                                        │  │
│  │  🔢 CONFUSION MATRIX TAB                                               │  │
│  │  • Risk model confusion matrix heatmap                                │  │
│  │  • Stage model confusion matrix heatmap                               │  │
│  │                                                                        │  │
│  │  ⚡ FEATURE IMPORTANCE TAB                                             │  │
│  │  • Model-derived feature importance (not heuristic)                   │  │
│  │  • Top 15 features for both models                                    │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                         DOCTOR MODE (Optional)                                │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  🔬 Clinical Details                                                   │  │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────────────┐ │  │
│  │  │  Patient Inputs:        │  │  Exposure History:                  │ │  │
│  │  │  • Fever: Yes (5 days)  │  │  • Tick Bite: Yes                   │ │  │
│  │  │  • Bleeding: Yes (2 d)  │  │  • Livestock: Yes                   │ │  │
│  │  │  • Headache: Yes        │  │  • Occupation: Butcher              │ │  │
│  │  │  • Vomiting: No         │  │  • Region: Turkey                   │ │  │
│  │  │  • Muscle Pain: Yes     │  │  • Month: July (Summer peak)        │ │  │
│  │  │  • Platelet: 80,000     │  │  • Endemic Level: High (2)          │ │  │
│  │  └─────────────────────────┘  └─────────────────────────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════╗
║                           TECHNOLOGY STACK                                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  Frontend:  Streamlit (Multi-page UI Framework)                              ║
║  ML Model:  Scikit-learn (GradientBoosting / RandomForest)                   ║
║  Charts:    Plotly (Gauge, Bar Charts, ROC Curves, Heatmaps)                 ║
║  NLP:       Google Gemini AI (Symptom Parsing, Explanations)                 ║
║  Reports:   ReportLab (PDF Generation)                                       ║
║  Data:      Pandas, NumPy                                                    ║
║  Storage:   Pickle (model_v2.pkl, stage_model_v2.pkl)                        ║
║             JSON (evaluation_metrics.json, roc_data.json)                    ║
╚══════════════════════════════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════════════════════════════╗
║                    KEY ARCHITECTURE PRINCIPLES                                ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  ✅ FULLY MODEL-DRIVEN: All predictions come from trained ML models          ║
║  ✅ NO HEURISTIC ADJUSTMENTS: No post-prediction probability manipulation    ║
║  ✅ FEATURES LEARNED DURING TRAINING: Occupation, region, season encoded     ║
║  ✅ DIRECT MODEL PROBABILITIES: predict_proba() output used directly         ║
║  ✅ COMPREHENSIVE VALIDATION: 5-fold CV + holdout test set                   ║
║  ✅ TRANSPARENT EVALUATION: Metrics, ROC, confusion matrix displayed         ║
╚══════════════════════════════════════════════════════════════════════════════╝

╔══════════════════════════════════════════════════════════════════════════════╗
║                         FEATURE SUMMARY                                       ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  ✅ 1. Extended Inputs (28 WHO-aligned features)                             ║
║  ✅ 2. Risk Gauge (Plotly gauge with color zones)                            ║
║  ✅ 3. Regional Risk Display (Endemic level indicator)                       ║
║  ✅ 4. AI Explanation (Gemini-powered clinical reasoning)                    ║
║  ✅ 5. Seasonal Encoding (month_sin/cos learned by model)                    ║
║  ✅ 6. Occupation Risk (Encoded as input feature, not multiplier)            ║
║  ✅ 7. Probability Chart (Bar chart with Low/Med/High)                       ║
║  ✅ 8. Clinical Recommendations (Risk-stratified protocols)                  ║
║  ✅ 9. Confidence Indicator (Direct model confidence %)                      ║
║  ✅ 10. Doctor vs Public Mode (Toggle display detail)                        ║
║  ✅ 11. PDF Report Export (Comprehensive patient report)                     ║
║  ✅ 12. Model Transparency Dashboard (Metrics, ROC, Confusion Matrix)        ║
║  ✅ 13. Outbreak Simulation (Epidemiological scenario modeling)              ║
╚══════════════════════════════════════════════════════════════════════════════╝
